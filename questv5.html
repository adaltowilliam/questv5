<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Quiz â€” Conhecimentos BancÃ¡rios</title>
<style>
  :root{--bg:#0b1020;--card:#121832;--muted:#9fb0ff;--text:#e9edff;--accent:#6ea8fe;--ok:#45c26b;--err:#e05050}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(120deg,#0b1020,#0e1430 60%,#0b1020)}
  .container{max-width:980px;margin:32px auto;padding:0 16px}
  header{display:flex;align-items:center;justify-content:space-between;color:var(--text);gap:12px}
  .brand{font-weight:700;font-size:20px;letter-spacing:.4px}
  .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
  .controls{padding:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:16px}
  .controls label{color:var(--muted);font-size:.9rem}
  .controls select,.controls input,.controls button{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0f1530;color:var(--text)
  }
  .controls button{cursor:pointer;border:0;background:var(--accent);color:#0a0e1f;font-weight:700}
  .controls button:disabled{opacity:.5;cursor:not-allowed}
  .status{margin-top:10px;color:var(--muted);font-size:.9rem}
  .quiz{margin-top:20px;padding:18px}
  .qhead{display:flex;justify-content:space-between;align-items:center;color:var(--text);gap:12px}
  .progress{height:10px;background:#0f1530;border:1px solid rgba(255,255,255,.1);border-radius:999px;overflow:hidden;margin:10px 0 18px}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#6ea8fe,#91f2ff)}
  .stem{white-space:pre-wrap;color:#eaf0ff;font-size:1.05rem;line-height:1.55;margin:10px 0 12px}
  .options{display:grid;gap:10px;margin:10px 0}
  .opt{display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1633;color:var(--text);cursor:pointer}
  .opt input{margin-top:3px}
  .opt.correct{border-color:rgba(69,194,107,.6);background:rgba(69,194,107,.08)}
  .opt.wrong{border-color:rgba(224,80,80,.6);background:rgba(224,80,80,.06)}
  .actions{display:flex;gap:10px;margin-top:8px}
  .btn{padding:12px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--accent);color:#0a0e1f}
  .btn-outline{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.2)}
  .result{margin-top:12px;padding:12px;border-radius:12px;border:1px dashed rgba(255,255,255,.2);color:var(--text)}
  .muted{color:var(--muted)}
  .badge{padding:6px 10px;border-radius:999px;font-size:.8rem;font-weight:700}
  .badge-ok{background:rgba(69,194,107,.18);border:1px solid rgba(69,194,107,.6);color:#bff3cd}
  .badge-err{background:rgba(224,80,80,.15);border:1px solid rgba(224,80,80,.6);color:#ffd2d2}
  .score{font-weight:800}
  .footer{margin:24px 0 12px;color:var(--muted);text-align:center;font-size:.85rem}
  details{margin-top:10px}
  summary{cursor:pointer;color:var(--muted)}
  .source{font-size:.9rem;color:#a9b7ff;margin-top:6px}
  @media (max-width:760px){.controls{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">ðŸ“˜ Quiz â€” Conhecimentos BancÃ¡rios</div>
    <div id="authState" class="muted">Conectandoâ€¦</div>
  </header>

  <section class="card controls">
    <div>
      <label>MatÃ©ria (subject)</label>
      <select id="subject">
        <option>Conhecimentos BancÃ¡rios</option>
      </select>
    </div>
    <div>
      <label>Quantas questÃµes?</label>
      <select id="qty">
        <option>5</option><option selected>10</option><option>15</option><option>20</option><option>30</option>
      </select>
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="btnStart">Carregar e iniciar</button>
    </div>
    <div class="status" id="status">Pronto para buscar do Firestore.</div>
  </section>

  <section class="card quiz" id="quiz" hidden>
    <div class="qhead">
      <div><span id="qIndex">1</span>/<span id="qTotal">0</span></div>
      <div>Acertos: <span class="score" id="hits">0</span></div>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <div class="stem" id="stem">â€”</div>
    <div class="options" id="options"></div>
    <div class="actions">
      <button class="btn btn-primary" id="btnSubmit">Confirmar resposta</button>
      <button class="btn btn-outline" id="btnNext" disabled>PrÃ³xima</button>
    </div>
    <div class="result" id="feedback" hidden></div>
  </section>

  <section class="footer">
    Feito para estudos de concurso (BB/Cesgranrio). Dados lidos do Firestore em tempo real.
  </section>
</div>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
  // 1) COLE SUAS CREDENCIAIS AQUI (MESMAS DO UPLOADER)
const firebaseConfig = {
    apiKey: "AIzaSyDykOJ5SRf1rqO7EeUPiIQRzTU8G_NLUZg",
    authDomain: "questv5.firebaseapp.com",
    projectId: "questv5",
    storageBucket: "questv5.firebasestorage.app",
    messagingSenderId: "537224931706",
    appId: "1:537224931706:web:8e32d9794fbe17c7858ec3",
    measurementId: "G-WD22G14TFB"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const $ = id => document.getElementById(id);
  const authState = $("authState");
  auth.onAuthStateChanged(u => authState.textContent = u ? "Conectado (anÃ´nimo)" : "Desconectado");
  auth.signInAnonymously().catch(e=> authState.textContent = "Falha auth: "+e.message);

  // util
  const shuffle = arr => { for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr };

  // estado
  let QUESTIONS = [];
  let CURRENT = 0;
  let HITS = 0;
  let LOCKED = false;

  async function fetchQuestions(subject, qty){
    $("status").textContent = "Buscando questÃµesâ€¦";
    // EstratÃ©gia: traz atÃ© 100 aleatÃ³rias (client-side) do subject, depois recorta 'qty'
    // Se quiser tudo, aumente o limit.
    const snap = await db.collection("questions")
      .where("subject","==", subject)
      .limit(100) // ajuste se precisar
      .get();

    const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    if(all.length === 0) throw new Error("Nenhuma questÃ£o encontrada para o subject escolhido.");
    const picked = shuffle(all).slice(0, qty);
    return picked;
  }

  function renderQuestion(){
    const total = QUESTIONS.length;
    const q = QUESTIONS[CURRENT];
    $("qIndex").textContent = (CURRENT+1);
    $("qTotal").textContent = total;
    const pct = Math.round(((CURRENT)/total)*100);
    $("bar").style.width = pct+"%";

    $("stem").textContent = q.stem || "(sem enunciado)";
    const optsEl = $("options");
    optsEl.innerHTML = "";

    const letters = Object.keys(q.options || {});
    letters.forEach(letter=>{
      const label = document.createElement("label");
      label.className = "opt";
      label.innerHTML = `
        <input type="radio" name="opt" value="${letter}"/>
        <div><b>${letter})</b> ${q.options[letter]}</div>
      `;
      optsEl.appendChild(label);
    });

    $("feedback").hidden = true;
    $("feedback").innerHTML = "";
    $("btnSubmit").disabled = false;
    $("btnNext").disabled = true;
    LOCKED = false;
  }

  function getSelected(){
    const r = document.querySelector('input[name="opt"]:checked');
    return r ? r.value : null;
  }

  function showFeedback(isCorrect, correctLetter, explanation, source){
    const fb = $("feedback");
    fb.hidden = false;
    const badge = isCorrect
      ? `<span class="badge badge-ok">Acertou!</span>`
      : `<span class="badge badge-err">Errou</span>`;
    fb.innerHTML = `
      <div>${badge} <b>Gabarito: ${correctLetter}</b></div>
      ${explanation ? `<div style="margin-top:8px">${explanation}</div>` : ""}
      ${source ? `<div class="source">Fonte: ${source}</div>` : ""}
    `;

    // Marca visual nas alternativas
    const labels = Array.from(document.querySelectorAll(".opt"));
    labels.forEach(l=>{
      const input = l.querySelector("input");
      if(input.value === correctLetter) l.classList.add("correct");
      if(!isCorrect && input.checked) l.classList.add("wrong");
    });
  }

  $("btnStart").onclick = async ()=>{
    try{
      $("btnStart").disabled = true;
      $("status").textContent = "Carregandoâ€¦";
      const subject = $("subject").value;
      const qty = parseInt($("qty").value,10);

      QUESTIONS = await fetchQuestions(subject, qty);
      CURRENT = 0; HITS = 0;

      $("hits").textContent = HITS;
      $("quiz").hidden = false;
      renderQuestion();
      $("status").textContent = `Carregadas ${QUESTIONS.length} questÃµes. Bom estudo!`;
    }catch(e){
      $("status").textContent = "Erro: " + e.message;
    }finally{
      $("btnStart").disabled = false;
    }
  };

  $("btnSubmit").onclick = ()=>{
    if(LOCKED) return;
    const q = QUESTIONS[CURRENT];
    const chosen = getSelected();
    if(!chosen){ $("status").textContent = "Selecione uma alternativa."; return; }

    const ok = Array.isArray(q.answer) ? q.answer.includes(chosen) : (chosen === q.answer);
    if(ok) HITS++;
    $("hits").textContent = HITS;

    showFeedback(ok, Array.isArray(q.answer)? q.answer.join(",") : q.answer, q.explanation, q.source);
    $("btnSubmit").disabled = true;
    $("btnNext").disabled = false;
    LOCKED = true;
  };

  $("btnNext").onclick = ()=>{
    if(CURRENT < QUESTIONS.length-1){
      CURRENT++;
      renderQuestion();
    } else {
      // fim
      $("bar").style.width = "100%";
      const total = QUESTIONS.length;
      const pct = Math.round((HITS/total)*100);
      const fb = $("feedback");
      fb.hidden = false;
      fb.innerHTML = `
        <div style="font-size:1.1rem"><b>Fim do quiz!</b></div>
        <div class="muted">VocÃª acertou <b>${HITS}</b> de <b>${total}</b> (${pct}%).</div>
        <details><summary>Reiniciar</summary>
          <div style="margin-top:8px">Clique novamente em <b>Carregar e iniciar</b> para outro conjunto.</div>
        </details>
      `;
      $("btnSubmit").disabled = true;
      $("btnNext").disabled = true;
    }
  };
</script>
</body>
</html>
