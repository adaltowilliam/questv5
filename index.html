<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Interativo do PDF</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#111827; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#f97316; --error:#ef4444;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f17,#0a1324);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:20px}
    .topbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid rgba(255,255,255,.06);padding:14px 16px;border-radius:var(--radius);position:sticky;top:10px;z-index:9;backdrop-filter:blur(6px)}
    .left{display:flex;gap:12px;align-items:center}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .title{font-weight:700;letter-spacing:.2px}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{border-color:rgba(255,255,255,.25)}
    .btn.primary{background:linear-gradient(180deg,#1f9d67,#16824f);border:none}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.18)}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#b45309);border:none}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border:none}
    .badge{font-size:12px;color:#d1d5db;background:#1f2937;border-radius:999px;padding:6px 10px;border:1px solid rgba(255,255,255,.06)}
    .progress{height:10px;background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#10b981 40%,#84cc16);transition:width .3s ease}

    .card{margin-top:16px;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);overflow:hidden}
    .card .hd{padding:18px 18px 8px 18px;border-bottom:1px dashed rgba(255,255,255,.08)}
    .card .bd{padding:18px}
    
    .management-panel {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-top: 16px;
        background: var(--card);
        border: 1px solid rgba(255,255,255,.08);
        border-radius: var(--radius);
        padding: 18px;
    }
    .management-panel h3 {
        margin: 0 0 12px 0;
        border-bottom: 1px dashed rgba(255,255,255,.08);
        padding-bottom: 8px;
    }
    .management-panel .section {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .q-meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .q-title{font-weight:700;font-size:18px;line-height:1.3;white-space: pre-wrap;}
    /* AQUI: REMOVIDO .q-text { white-space: pre-wrap; } QUE N√ÉO ESTAVA SENDO USADO */
    .q-list { margin-top: 12px; padding-left: 20px; }
    .q-list li { margin-bottom: 8px; }

    .opts{display:grid;gap:10px;margin-top:16px}
    .opt{border:1px solid rgba(255,255,255,.10);padding:14px 16px;border-radius:14px;display:flex;gap:12px;align-items:flex-start;background:#0b1220;cursor:pointer;transition:border-color .2s ease, background .2s ease}
    .opt input{margin-top:4px}
    .opt:hover{border-color:rgba(255,255,255,.25)}
    .opt.correct{border-color:var(--accent);background:rgba(34,197,94,.08)}
    .opt.wrong{border-color:var(--error);background:rgba(239,68,68,.08)}
    .opt.disabled{opacity:.75;cursor:not-allowed}

    .feedback{margin-top:12px;padding:14px;border:1px solid rgba(255,255,255,.10);border-left-width:6px;border-radius:12px;background:#0b1220}
    .feedback.ok{border-left-color:var(--accent)}
    .feedback.bad{border-left-color:var(--error)}
    .feedback h4{margin:0 0 6px 0}
    .feedback .small{line-height:1.4;margin-top:8px}

    .footer{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:16px}
    .hint{color:var(--muted);font-size:13px}

    .summary{display:grid;gap:14px}
    .summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .stat{background:#0b1220;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:14px;text-align:center}
    .list{display:grid;gap:14px}
    .rev-card{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;background:#0b1220}
    .small{font-size:13px;color:var(--muted)}

    .hidden{display:none}
    .spacer{height:6px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0b1220;border:1px solid rgba(255,255,255,.15);padding:2px 6px;border-radius:6px;font-size:12px}
    .file{display:none}
    .toggle{display:flex;gap:8px;align-items:center}
    
    select, input[type=text], input[type=number] {
      background: #0b1220;
      border: 1px solid rgba(255, 255, 255, .12);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-family: inherit;
      min-width: 120px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="left">
        <div class="title">üìò Quiz do PDF</div>
        <span class="badge" id="quizId">‚Äî</span>
        <span class="badge" id="qCount">0 quest√µes</span>
      </div>
      <div class="right">
        <button id="btnRestart" class="btn danger">Reiniciar</button>
      </div>
    </div>

    <div class="management-panel">
        <h3>Come√ßar a estudar</h3>
        <div class="section">
            <select id="selectMateria">
                <option value="">Mat√©ria</option>
            </select>
            <select id="selectDisciplina" disabled>
                <option value="">Disciplina</option>
            </select>
            <input type="number" id="qLimit" value="10" min="1" max="1000" style="width:70px">
            <button id="btnLoadFromDB" class="btn primary">Carregar</button>
        </div>
        <h3 style="margin-top:24px;">Adicionar Quest√µes</h3>
        <div class="section">
            <input type="text" id="materia_name" placeholder="Nome da Mat√©ria">
            <input type="text" id="disciplina_name" placeholder="Nome da Disciplina">
            <label class="btn ghost" for="file">Carregar JSON</label>
            <input id="file" type="file" accept=".json,application/json" class="file" />
            <button id="btnSave" class="btn primary">Salvar Quiz</button>
        </div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="q-meta">
          <div id="progressText" class="badge">‚Äî</div>
          <div id="scoreText" class="badge">Acertos 0 ‚Ä¢ Erros 0</div>
        </div>
        <div class="spacer"></div>
        <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
      </div>
      <div class="bd" id="stage">
        </div>
    </div>

    <div class="card" id="howto">
      <div class="hd"><strong>Como usar (r√°pido):</strong></div>
      <div class="bd">
        <ol>
          <li>Para **estudar**, escolha a Mat√©ria, a Disciplina e a quantidade de quest√µes acima e clique em 'Carregar'.</li>
          <li>Para **adicionar**, insira o nome da Mat√©ria, Disciplina e carregue o arquivo JSON para salvar no banco de dados.</li>
        </ol>
        <p class="small">Dica: o estado fica salvo por <span class="kbd">localStorage</span>. Se voc√™ trocar o banco de quest√µes, o sistema detecta e come√ßa tudo do zero automaticamente.</p>
      </div>
    </div>

  </div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
/*
====================================================================
üíæ FORMATO DO JSON ESPERADO (exemplo m√≠nimo)
Voc√™ pode usar um array direto ou um objeto { questions: [...] }.
Cada quest√£o:
{
  "id": "61",
  "enunciado": "Texto completo do enunciado...",
  "alternativas": [
    {"letra":"A","texto":"..."},
    {"letra":"B","texto":"..."},
    {"letra":"C","texto":"..."},
    {"letra":"D":"..."}
    {"letra":"E":"..."}
  ],
  "correta": "B",
  "parecer": {
    "geral": "(opcional) Meu parecer resumido da quest√£o.",
    "A": "Por que a A est√° errada.",
    "B": "Por que a B √© a correta.",
    "C": "...",
    "D": "...",
    "E": "..."
  }
}
====================================================================
*/

// --- Configura√ß√£o do Firebase e Firestore ---
const firebaseConfig = {
    apiKey: "AIzaSyDykOJ5SRf1rqO7EeUPiIQRzTU8G_NLUZg",
    authDomain: "questv5.firebaseapp.com",
    projectId: "questv5",
    storageBucket: "questv5.firebasestorage.app",
    messagingSenderId: "537224931706",
    appId: "1:537224931706:web:8e32d9794fbe17c7858ec3",
    measurementId: "G-WD22G14TFB"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- Fun√ß√µes de Intera√ß√£o com o Firestore ---
async function fetchSubjects() {
    const materiasRef = db.collection("materias");
    try {
      const snapshot = await materiasRef.get();
      const select = $('#selectMateria');
      select.innerHTML = '<option value="">Mat√©ria</option>';
      if (snapshot.docs.length > 0) {
        snapshot.forEach(doc => {
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = doc.id;
            select.appendChild(option);
        });
        select.disabled = false;
      }
    } catch (error) {
      alert("Erro ao carregar mat√©rias: " + error.message);
    }
}

async function fetchDisciplines(materia) {
    const disciplinasRef = db.collection("materias").doc(materia).collection("disciplinas");
    try {
      const snapshot = await disciplinasRef.get();
      const select = $('#selectDisciplina');
      select.innerHTML = '<option value="">Disciplina</option>';
      if (!snapshot.empty) {
          snapshot.forEach(doc => {
              const option = document.createElement('option');
              option.value = doc.id;
              option.textContent = doc.id;
              select.appendChild(option);
          });
          select.disabled = false;
      } else {
          select.disabled = true;
      }
    } catch (error) {
      alert("Erro ao carregar disciplinas: " + error.message);
    }
}

async function saveQuizToFirestore(materia, disciplina, questions) {
    if (!materia || !disciplina || !questions || questions.length === 0) {
        throw new Error("Mat√©ria, disciplina ou quest√µes n√£o podem estar vazios.");
    }
    
    await db.collection("materias").doc(materia).set({}, { merge: true });

    const questionsRef = db.collection("materias")
        .doc(materia)
        .collection("disciplinas")
        .doc(disciplina)
        .collection("questoes");

    const batch = db.batch();
    questions.forEach(q => {
        const newQuestionRef = questionsRef.doc(String(q.id));
        batch.set(newQuestionRef, q);
    });

    await batch.commit();
    return `Quiz "${disciplina}" salvo com sucesso na mat√©ria "${materia}"!`;
}

async function loadQuizFromFirestore(materia, disciplina) {
    if (!materia) {
        throw new Error("Por favor, selecione uma Mat√©ria.");
    }

    let allQuestions = [];

    if (!disciplina) {
        const disciplinasRef = db.collection("materias").doc(materia).collection("disciplinas");
        const disciplinasSnapshot = await disciplinasRef.get();
        if (disciplinasSnapshot.empty) {
            throw new Error(`Nenhuma disciplina encontrada para a mat√©ria "${materia}".`);
        }

        for (const doc of disciplinasSnapshot.docs) {
            const questoesRef = doc.ref.collection("questoes");
            const questoesSnapshot = await questoesRef.get();
            questoesSnapshot.forEach(qDoc => {
                allQuestions.push(qDoc.data());
            });
        }
    } else {
        const questionsRef = db.collection("materias")
            .doc(materia)
            .collection("disciplinas")
            .doc(disciplina)
            .collection("questoes");
        
        const snapshot = await questionsRef.get();
        if (snapshot.empty) {
            throw new Error(`Nenhuma quest√£o encontrada para a disciplina "${disciplina}" na mat√©ria "${materia}".`);
        }
        
        snapshot.forEach(doc => {
            allQuestions.push(doc.data());
        });
    }

    if (allQuestions.length === 0) {
        throw new Error("Nenhuma quest√£o foi carregada.");
    }

    // Embaralha todas as quest√µes antes de aplicar o limite
    const shuffledQuestions = shuffle(allQuestions);
    
    // Aplica o limite de quest√µes
    const limit = parseInt(qLimit.value) || shuffledQuestions.length;
    const limitedQuestions = shuffledQuestions.slice(0, limit);

    QUIZ = {
        meta: {
            id: disciplina || materia,
            title: `Quiz de ${disciplina || materia}`,
            version: 1
        },
        questions: normalize(limitedQuestions)
    };
    
    prepareOrder();
    resetProgress();
    syncHeader();
    render();
    return `Quiz de "${disciplina || materia}" carregado com sucesso.`;
}

// ‚Äî‚Äî Estado global ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
let QUIZ = {
  meta: { id: "DEMO-PDF", title: "DEMO", version: 1 },
  questions: []
};
let ORDER = [];
let IDX = 0;
let ST = {
  answers: {},
  hits: 0,
  misses: 0,
  finished: false
};

// ‚Äî‚Äî Utilidades ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
const $ = sel => document.querySelector(sel);
const stage = $('#stage');
const progressText = $('#progressText');
const scoreText = $('#scoreText');
const bar = $('#bar');
const quizBadge = $('#quizId');
const qCount = $('#qCount');
const inputMateriaName = $('#materia_name');
const inputDisciplinaName = $('#disciplina_name');
const selectMateria = $('#selectMateria');
const selectDisciplina = $('#selectDisciplina');
const qLimit = $('#qLimit');

function hash(str){
  let h = 2166136261>>>0; for(let i=0;i<str.length;i++){h ^= str.charCodeAt(i); h = Math.imul(h, 16777619);} return (h>>>0).toString(36);
}
function save(){
  const key = storageKey();
  localStorage.setItem(key, JSON.stringify({ QUIZ, ORDER, IDX, ST }));
}
function load(key){
  const raw = localStorage.getItem(key||storageKey());
  if(!raw) return false;
  try{ const obj = JSON.parse(raw); ({ QUIZ, ORDER, IDX, ST } = obj); return true; }catch(e){ return false; }
}
function storageKey(){
  const payload = JSON.stringify(QUIZ.questions.map(q=>q.id+q.correta+q.enunciado.length));
  return 'quizpdf:'+hash(payload);
}
function resetProgress(){
  ST = { answers:{}, hits:0, misses:0, finished:false };
  IDX = 0; save();
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

// ‚Äî‚Äî Carregamento de banco ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
async function loadFromJSONFile(file){
  const text = await file.text();
  let data = JSON.parse(text);
  if(Array.isArray(data)) data = { questions: data };
  if(!Array.isArray(data.questions)) throw new Error('JSON inv√°lido: n√£o h√° "questions".');
  QUIZ = { meta:{ id: file.name.replace(/\.[^.]+$/,''), title: file.name, version: 1 }, questions: normalize(data.questions) };
  
  prepareOrder();
  resetProgress();
  syncHeader();
  render();
}
function normalize(arr){
  return arr.map((q,i)=>({
    id: q.id ?? String(i+1),
    enunciado: q.enunciado?.trim() ?? '',
    alternativas: (q.alternativas||[]).map((a,j)=>({
      letra: a.letra ?? String.fromCharCode(65+j),
      texto: (a.texto??'').trim()
    })),
    correta: (q.correta||'').toString().trim().toUpperCase(),
    parecer: q.parecer || null
  }));
}
function prepareOrder(){
    const allIds = QUIZ.questions.map((_, i) => i);
    ORDER = allIds;
}

// --- Fun√ß√µes de An√°lise de Erros ---
function analyzeErrors(wrongQuestions) {
  const errorThemes = {};
  const keywords = {
    'CMN': 'Conselho Monet√°rio Nacional',
    'Bacen': 'Banco Central do Brasil',
    'CVM': 'Comiss√£o de Valores Mobili√°rios',
    'SFN': 'Sistema Financeiro Nacional',
    'Pol√≠tica Monet√°ria': 'Pol√≠tica Monet√°ria',
    '√≥rg√£o normativo': '√ìrg√£os Normativos',
    '√≥rg√£o supervisor': '√ìrg√£os Supervisores',
    'Mercado de Capitais': 'Mercado de Capitais',
    'FGC': 'Fundo Garantidor de Cr√©ditos',
    'Susep': 'Superintend√™ncia de Seguros Privados'
  };

  wrongQuestions.forEach(q => {
    const textToAnalyze = (q.enunciado + ' ' + (q.parecer?.geral || '')).toLowerCase();
    for (const key in keywords) {
      if (textToAnalyze.includes(key.toLowerCase())) {
        errorThemes[keywords[key]] = (errorThemes[keywords[key]] || 0) + 1;
      }
    }
  });

  const sortedThemes = Object.entries(errorThemes).sort(([, a], [, b]) => b - a);
  return sortedThemes;
}

// ‚Äî‚Äî UI principal ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function syncHeader(){
  quizBadge.textContent = QUIZ.meta.id;
  qCount.textContent = `${ORDER.length} quest√£o${ORDER.length===1?'':'es'}`;
}
function render(){
  if(!QUIZ.questions.length){
    stage.innerHTML = `<p class="small">Nenhuma quest√£o carregada ainda. Use a se√ß√£o 'Come√ßar a estudar' ou 'Adicionar Quest√µes' acima.</p>`;
    updateBar();
    return;
  }
  if(ST.finished){
    renderSummary();
    return;
  }
  IDX = clamp(IDX,0,ORDER.length-1);
  const q = QUIZ.questions[ ORDER[IDX] ];
  const ans = ST.answers[q.id];
  progressText.textContent = `Quest√£o ${IDX+1} de ${ORDER.length}`;
  scoreText.textContent = `Acertos ${ST.hits} ‚Ä¢ Erros ${ST.misses}`;
  updateBar();

  const opts = q.alternativas.map((a)=>{
    const chosen = ans?.chosen === a.letra;
    const classes = ['opt'];
    if(ans){ classes.push(a.letra===q.correta?'correct':(chosen?'wrong':'')); }
    return `
      <label class="${classes.join(' ')}" data-letra="${a.letra}">
        <input type="radio" name="opt" value="${a.letra}" ${chosen?'checked':''} ${ans?'disabled':''} />
        <div><strong>${a.letra})</strong> ${escapeHTML(a.texto)}</div>
      </label>`;
  }).join('');
  
  // AQUI: removido a l√≥gica de regex para quebra de linha que estava com problemas.
  // O enunciado principal agora renderiza o texto diretamente com a nova propriedade CSS.
  let mainEnunciado = q.enunciado;
  
  stage.innerHTML = `
    <div class="q">
      <div class="q-title">${mainEnunciado}</div>
      <div class="opts" id="opts">${opts}</div>
      <div id="feedback"></div>
      <div class="footer">
        <div class="hint">Use <span class="kbd">‚Üí</span> para pr√≥xima ‚Ä¢ <span class="kbd">‚Üê</span> para anterior</div>
        <div class="footer-btns">
          <button class="btn ghost" id="prev">‚óÄ Anterior</button>
          <button class="btn primary" id="next">Pr√≥xima ‚ñ∂</button>
          <button class="btn warn" id="finish">Finalizar</button>
        </div>
      </div>
    </div>`;

  $('#prev').onclick = ()=>{ IDX = Math.max(0, IDX-1); save(); render(); }
  $('#next').onclick = ()=>{ IDX = Math.min(ORDER.length-1, IDX+1); save(); render(); }
  $('#finish').onclick = ()=>{ ST.finished = true; save(); renderSummary(); }

  $('#opts').onclick = (ev)=>{
    const label = ev.target.closest('label.opt');
    if(!label) return;
    if(ST.answers[q.id]) return;
    const letra = label.getAttribute('data-letra');
    evaluate(q, letra);
  }

  if(ans){
    showFeedback(q, ans.chosen);
  }
}

function evaluate(q, letra){
  const isCorrect = (letra === q.correta);
  ST.answers[q.id] = { chosen: letra, correct: isCorrect };
  if(isCorrect) ST.hits++; else ST.misses++;
  save();
  render();
  showFeedback(q, letra);
}

function showFeedback(q, chosen){
  const ok = chosen === q.correta;
  const fb = $('#feedback');
  const parecer = (q.parecer && (q.parecer[chosen] || q.parecer.geral)) || genericOpinion(q, chosen);
  const parecerCorreta = (q.parecer && q.parecer[q.correta]) || 'Esta √© a alternativa alinhada ao gabarito informado.';

  fb.innerHTML = `
    <div class="feedback ${ok?'ok':'bad'}">
      <h4>${ok?'‚úÖ Resposta correta!':'‚ùå Resposta errada.'}</h4>
      <div class="small">Gabarito: <strong>${q.correta}</strong> ‚Ä¢ Sua resposta: <strong>${chosen}</strong></div>
      <div style="margin-top:8px">${escapeHTML(parecer)}</div>
      <details style="margin-top:10px"><summary>Ver an√°lise alternativa por alternativa</summary>
        <ul style="margin-top:8px">
          ${q.alternativas.map(a=>`<li><strong>${a.letra})</strong> ${escapeHTML(a.texto)}<br><span class="small"><strong>Parecer de Gemini:</strong> ${escapeHTML((q.parecer && q.parecer[a.letra]) || (a.letra===q.correta?parecerCorreta:'N√£o √© a melhor op√ß√£o para o enunciado.'))}</span></li>`).join('')}
        </ul>
      </details>
    </div>`;
}

function genericOpinion(q, chosen){
  return chosen===q.correta
    ? 'Boa! A alternativa escolhida atende ao n√∫cleo do enunciado conforme os termos-chave apresentados.'
    : 'A alternativa marcada n√£o casa com o n√∫cleo sem√¢ntico do enunciado. Compare os termos-chave e a condi√ß√£o pedida com a alternativa correta.';
}

function updateBar(){
  const total = ORDER.length || 1;
  const current = Math.min(ORDER.length, Object.keys(ST.answers).length);
  bar.style.width = ((current/total)*100).toFixed(1)+'%';
}

function renderSummary(){
  const total = ORDER.length;
  const pct = total? Math.round((ST.hits/total)*100) : 0;
  progressText.textContent = `Resumo`;
  scoreText.textContent = `Acertos ${ST.hits} ‚Ä¢ Erros ${ST.misses}`;
  updateBar();

  const wrong = ORDER.map(i=>QUIZ.questions[i]).filter(q=>ST.answers[q.id]?.correct === false);
  const errorAnalysis = analyzeErrors(wrong);

  stage.innerHTML = `
    <div class="summary">
      <div class="summary-grid">
        <div class="stat"><div class="small">Acerto</div><div style="font-size:28px;font-weight:800">${pct}%</div></div>
        <div class="stat"><div class="small">Acertos</div><div style="font-size:22px;font-weight:700">${ST.hits}/${total}</div></div>
        <div class="stat"><div class="small">Erros</div><div style="font-size:22px;font-weight:700">${ST.misses}</div></div>
      </div>
      <div>
        <button class="btn primary" id="btnRever">Rever quest√µes erradas</button>
        <button class="btn ghost" id="btnVoltar">Voltar ao quiz</button>
      </div>
      <div id="review" class="list hidden"></div>
    </div>`;

  $('#btnVoltar').onclick = ()=>{ ST.finished=false; save(); render(); }
  $('#btnRever').onclick = ()=>{
    const list = $('#review');
    const wrong = ORDER.map(i=>QUIZ.questions[i]).filter(q=>ST.answers[q.id]?.correct === false);
    
    let analysisHTML = '';
    if (wrong.length > 0) {
      const errorAnalysis = analyzeErrors(wrong);
      analysisHTML = `
        <div class="card" style="padding:18px; margin-bottom: 16px;">
          <h4>üéØ Pontos de aten√ß√£o</h4>
          <p>Com base em suas quest√µes erradas, voc√™ pode focar em:</p>
          <ul>
            ${errorAnalysis.map(([theme, count]) => `<li><strong>${theme}</strong> (${count} quest√µes)</li>`).join('')}
          </ul>
          <p class="small">Esta √© uma an√°lise inteligente baseada nas palavras-chave mais frequentes nas quest√µes que voc√™ errou.</p>
        </div>
      `;
    }

    list.innerHTML = analysisHTML + (wrong.map(q=>{
      const chosen = ST.answers[q.id]?.chosen;
      const corr = q.correta;
      const motivo = (q.parecer && q.parecer[chosen]) || 'Sua alternativa n√£o responde exatamente ao que o enunciado exige.';
      return `<div class="rev-card">
        <div class="small">ID: ${q.id}</div>
        <div style="font-weight:700;margin:6px 0">${escapeHTML(q.enunciado)}</div>
        <ul style="margin:8px 0 12px 0">${q.alternativas.map(a=>`<li><strong>${a.letra})</strong> ${escapeHTML(a.texto)}</li>`).join('')}</ul>
        <div>Voc√™ marcou: <strong>${chosen}</strong> ‚Ä¢ Gabarito: <strong>${corr}</strong></div>
        <div class="small" style="margin-top:6px"><strong>Por que errou:</strong> ${escapeHTML(motivo)}</div>
      </div>`;
    }).join('') || '<p class="small">Nenhum erro üëè</p>');
    list.classList.remove('hidden');
  }
}

// ‚Äî‚Äî A√ß√µes da topbar ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
$('#file').addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  loadFromJSONFile(f).catch(err=>alert('Erro ao carregar JSON: '+err.message));
});
$('#btnRestart').onclick = ()=>{
  if(confirm('Reiniciar progresso? Isso zera suas respostas salvas.')){
    resetProgress(); render();
  }
};
$('#btnSave').onclick = async () => {
    const materia = inputMateriaName.value;
    const disciplina = inputDisciplinaName.value;
    if (!materia || !disciplina) {
        alert("Por favor, preencha a Mat√©ria e a Disciplina.");
        return;
    }
    try {
        const message = await saveQuizToFirestore(materia, disciplina, QUIZ.questions);
        alert(message);
        fetchSubjects();
    } catch (error) {
        alert("Erro ao salvar no Firestore: " + error.message);
    }
};

$('#btnLoadFromDB').onclick = async () => {
    const materia = selectMateria.value;
    const disciplina = selectDisciplina.value;
    const limit = parseInt(qLimit.value);
    
    if (!materia) {
        alert("Por favor, selecione uma Mat√©ria.");
        return;
    }
    try {
        const message = await loadQuizFromFirestore(materia, disciplina, limit);
        alert(message);
    } catch (error) {
        alert("Erro ao carregar do Firestore: " + error.message);
    }
};

selectMateria.onchange = (e) => {
    const materia = e.target.value;
    if (materia) {
        fetchDisciplines(materia).catch(err => {
            alert("Erro ao carregar disciplinas: " + err.message);
            selectDisciplina.innerHTML = '<option value="">Disciplina</option>';
            selectDisciplina.disabled = true;
        });
    } else {
        selectDisciplina.innerHTML = '<option value="">Disciplina</option>';
        selectDisciplina.disabled = true;
    }
};

qLimit.onchange = (e) => {
    const newLimit = parseInt(e.target.value);
    if (!isNaN(newLimit) && newLimit > 0 && QUIZ.questions.length > 0) {
        prepareOrder();
        resetProgress();
        render();
    }
}
qLimit.onkeydown = (e) => {
    if (e.key === 'Enter') {
        const newLimit = parseInt(e.target.value);
        if (!isNaN(newLimit) && newLimit > 0 && QUIZ.questions.length > 0) {
            prepareOrder();
            resetProgress();
            render();
        }
    }
}


// ‚Äî‚Äî Navega√ß√£o por teclado ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
document.addEventListener('keydown', (e)=>{
  if(ST.finished) return;
  if(e.key==='ArrowRight'){ IDX=Math.min(ORDER.length-1,IDX+1); save(); render(); }
  if(e.key==='ArrowLeft'){ IDX=Math.max(0,IDX-1); save(); render(); }
});

// ‚Äî‚Äî Helpers ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

// ‚Äî‚Äî Boot ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
(function boot(){
  const ok = load();
  syncHeader();
  if(!ok){
    stage.innerHTML = `<p class="small">Nenhuma quest√£o carregada ainda. Use a se√ß√£o 'Come√ßar a estudar' ou 'Adicionar Quest√µes' acima.</p>`;
  } else {
    render();
  }
  updateBar();
  fetchSubjects();
})();
</script>
</body>
</html>
